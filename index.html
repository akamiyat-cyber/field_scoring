<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>FieldEval Pro v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' }
                    }
                }
            }
        }
    </script>
    <style>
        /* 1Êú¨Êåá„Çπ„ÇØ„É≠„Éº„É´„ÇíË®±ÂèØ„Åó„Å§„Å§„ÄÅ„Éî„É≥„ÉÅÊìç‰Ωú„ÅØJS„ÅßÂà∂Âæ° */
        body { overscroll-behavior: none; }
        
        #mapContainer {
            overflow: auto;
            width: 100%;
            height: calc(100vh - 160px); /* „Çø„ÉñËøΩÂä†ÂàÜË™øÊï¥ */
            touch-action: pan-x pan-y;
            position: relative;
            background-color: #f3f4f6;
        }
        .dark #mapContainer { background-color: #0f172a; }

        #fieldMap { 
            display: flex; gap: 40px; padding: 40px;
            align-items: flex-start;
            transform-origin: 0 0;
            width: max-content;
        }

        .une-block {
            display: flex; gap: 12px;
            background: rgba(200, 200, 200, 0.2);
            border: 2px dashed #cbd5e1;
            padding: 40px 10px 10px 10px;
            border-radius: 16px; position: relative;
        }
        .dark .une-block { background: rgba(30, 41, 59, 0.5); border-color: #475569; }

        .une-header {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: white; padding: 4px 16px;
            border-radius: 20px; font-weight: 900; font-size: 0.9rem;
            white-space: nowrap; z-index: 5;
        }
        .dark .une-header { background: #3b82f6; }

        .plant-cell { 
            width: 90px; height: 100px;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            border-radius: 14px; background: white; 
            border: 2px solid #e2e8f0; 
            transition: transform 0.1s, border-color 0.1s;
        }
        .dark .plant-cell { background: #1e293b; border-color: #334155; color: white; }
        .selected { outline: 4px solid #3b82f6 !important; transform: scale(1.1); z-index: 20; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* „Éí„Çπ„Éà„Ç∞„É©„É†„Éê„Éº */
        .bar-container { display: flex; align-items: flex-end; height: 60px; gap: 2px; }
        .bar { flex: 1; background: #3b82f6; border-radius: 2px 2px 0 0; min-width: 8px; position: relative; }
        .bar:hover::after { content: attr(data-count); position: absolute; top: -20px; left: 0; right: 0; text-align: center; font-size: 10px; font-weight: bold; color: #3b82f6; }

        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .score-btn { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; border-radius: 12px; background: white; border: 2px solid #e2e8f0; color: #334155; }
        .dark .score-btn { background: #0f172a; border-color: #334155; color: #cbd5e1; }
        .score-input:checked + .score-btn { background: #2563eb; color: white; border-color: #2563eb; }
        
        /* ÁâπÂà•„Éú„Çø„É≥ÔºàÊ¨†Ê†™„ÉªË©ï‰æ°‰∏çËÉΩ„Éª„É™„Çª„ÉÉ„ÉàÔºâ */
        .special-btn { font-size: 0.8rem; border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
        .score-input:checked + .special-btn { background: #dc2626; color: white; border-color: #dc2626; }
        
        .reset-btn { font-size: 0.8rem; border-color: #cbd5e1; color: #64748b; background: #f1f5f9; }
        .score-input:checked + .reset-btn { background: #64748b; color: white; border-color: #64748b; }

        /* ÂÜôÁúü„Éó„É¨„Éì„É•„Éº */
        .photo-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ccc; display: none; }
        .photo-thumb.active { display: block; }

        /* „Çø„Éñ„Éá„Ç∂„Ç§„É≥ */
        .tab-container {
            display: flex; gap: 4px; overflow-x: auto; padding: 4px;
            scrollbar-width: none;
        }
        .tab-container::-webkit-scrollbar { display: none; }
        .tab-item {
            padding: 8px 16px; border-radius: 8px 8px 0 0; 
            font-weight: bold; font-size: 0.8rem; white-space: nowrap;
            background: rgba(255,255,255,0.5); color: #64748b; cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .dark .tab-item { background: rgba(30,41,59,0.5); color: #94a3b8; }
        .tab-item.active {
            background: white; color: #2563eb; border-bottom: 2px solid #2563eb;
        }
        .dark .tab-item.active {
            background: #1e293b; color: #60a5fa; border-bottom: 2px solid #60a5fa;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 dark:bg-dark-bg dark:text-gray-100 transition-colors duration-300 flex flex-col h-screen overflow-hidden">

<div class="bg-white dark:bg-dark-surface py-2 text-center border-b dark:border-dark-border z-50 shadow-sm shrink-0">
    <h1 class="text-xl font-black tracking-tight text-slate-900 dark:text-white">FieldEval <span class="text-blue-600">Pro</span></h1>
</div>

<div class="bg-white/90 dark:bg-dark-bg/95 backdrop-blur border-b border-gray-200 dark:border-dark-border z-40 shrink-0">
    <div id="tabs" class="tab-container bg-gray-200 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-700"></div>
    
    <div class="h-1 w-full bg-gray-200 dark:bg-gray-800"><div id="progressBar" class="h-full bg-blue-600 transition-all duration-500 w-0"></div></div>
    
    <div class="flex justify-between items-center p-2 max-w-7xl mx-auto overflow-x-auto gap-4">
        <div class="flex flex-col min-w-[120px]">
            <span id="progressText" class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">0% DONE</span>
        </div>

        <div class="flex items-center gap-2">
            <input type="range" min="0.5" max="2.0" step="0.1" value="1.0" id="zoomSlider" oninput="manualZoom(this.value)" class="w-20 accent-blue-600 hidden sm:block">
            <button onclick="openStats()" class="p-2 rounded-lg bg-gray-100 dark:bg-dark-surface font-bold text-xs flex items-center gap-1 whitespace-nowrap"><span>üìä</span> Stats</button>
            <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-dark-surface">üåó</button>
            <button onclick="openConfig()" class="p-2 rounded-lg bg-gray-100 dark:bg-dark-surface font-bold text-xs">‚öôÔ∏è</button>
            
            <label class="p-2 rounded-lg bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 font-bold text-xs cursor-pointer flex items-center gap-1 hover:opacity-80 transition-opacity">
                <span>üì•</span> Import
                <input type="file" accept=".csv,.txt" class="hidden" onchange="importSystemNames(event)">
            </label>

            <button onclick="exportData()" class="p-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-lg">Export</button>
        </div>
    </div>
</div>

<div id="mapContainer" class="flex-1">
    <div id="fieldMap"></div>
</div>

<footer class="bg-gray-200 dark:bg-black py-2 text-center text-[10px] text-gray-500 dark:text-gray-600 font-bold shrink-0 z-50">
    Created by Takehiro Kamiya (University of Tokyo) | Use at your own risk.
</footer>

<div id="statsModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex flex-col p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl flex-1 max-w-2xl mx-auto w-full flex flex-col overflow-hidden">
        <div class="p-4 border-b dark:border-dark-border flex justify-between items-center">
            <h3 class="font-black text-xl">üìä System Analysis</h3>
            <button onclick="document.getElementById('statsModal').classList.add('hidden')" class="text-2xl font-bold text-gray-400">&times;</button>
        </div>
        <div id="statsContent" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
    </div>
</div>

<div id="configModal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-dark-surface p-6 rounded-2xl w-full max-w-sm shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="font-black text-2xl mb-4">Field Settings</h3>
        
        <div class="space-y-4 font-bold text-sm">
            <div>
                <label class="text-xs text-gray-500">Field Name („Éï„Ç£„Éº„É´„ÉâÂêç)</label>
                <input type="text" id="cfg_fieldName" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg font-bold border border-gray-300 dark:border-gray-600">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="text-xs text-gray-500">Survey Date (Ë™øÊüªÊó•)</label>
                    <input type="date" id="meta_date" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg font-bold">
                </div>
                <div class="col-span-2">
                    <label class="text-xs text-gray-500">Surveyor (Ë™øÊüªËÄÖ)</label>
                    <input type="text" id="meta_surveyor" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg font-bold">
                </div>
                <div class="col-span-2">
                    <label class="text-xs text-gray-500">Crop Name (‰ΩúÁâ©Âêç)</label>
                    <input type="text" id="meta_crop" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg font-bold">
                </div>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-800">
                <label class="text-xs text-blue-500 font-bold block mb-2">Field Location (ÂúÉÂ†¥„ÅÆÂ†¥ÊâÄ)</label>
                <div class="flex gap-2">
                    <button onclick="setCurrentLocation()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold">üìç Get Current GPS</button>
                    <a id="mapsLink" href="#" target="_blank" class="hidden text-blue-600 text-xs font-bold underline flex items-center">Open Maps ‚Üó</a>
                </div>
                <input type="hidden" id="meta_lat"><input type="hidden" id="meta_lon">
                <p id="locationStatus" class="text-[10px] text-gray-400 mt-1">Not set</p>
            </div>

            <label class="flex justify-between items-center p-3 bg-gray-50 dark:bg-black/20 rounded-xl">
                <span>üìç Record GPS per plant</span>
                <input type="checkbox" id="cfg_useGPS" class="w-6 h-6 accent-blue-600">
            </label>
            
            <div class="grid grid-cols-2 gap-4 border-t pt-4 dark:border-gray-700">
                <div><label class="text-gray-400 text-xs">Rows (ÁïùÊï∞)</label><input type="number" id="cfg_rows" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Lines (Êù°Êï∞)</label><input type="number" id="cfg_lines" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Plants (ÂÄã‰ΩìÊï∞)</label><input type="number" id="cfg_plants" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Max Score</label><input type="number" id="cfg_maxScore" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
            </div>
            
            <div class="pt-4 border-t dark:border-dark-border space-y-2">
                <button onclick="resetFieldData()" class="w-full py-2 text-orange-500 font-bold hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors text-xs">
                    ‚ö†Ô∏è Reset Data Only
                </button>
                <button onclick="deleteCurrentField()" class="w-full py-2 text-red-500 font-bold hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors text-xs">
                    üóëÔ∏è Delete This Field
                </button>
            </div>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="document.getElementById('configModal').classList.add('hidden')" class="flex-1 py-4 font-bold text-gray-400">Cancel</button>
            <button onclick="saveFieldConfig()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold">Save</button>
        </div>
    </div>
</div>

<div id="inputModal" class="fixed inset-0 z-[100] hidden flex flex-col justify-end sm:justify-center items-center bg-black/60 backdrop-blur-sm">
    <div class="absolute inset-0" onclick="closeModal()"></div>
    <div class="modal-enter relative w-full sm:w-[400px] bg-white dark:bg-dark-surface sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl border-t border-white/20">
        <div class="flex justify-between items-start mb-4">
            <div class="w-full mr-4">
                <h2 id="currentIdLabel" class="text-4xl font-black text-blue-600 dark:text-blue-400 leading-none">--</h2>
                <div class="mt-2 flex items-center gap-2">
                    <input type="text" id="currentSystemInput" class="w-full bg-transparent border-b border-gray-300 dark:border-gray-600 font-bold text-gray-700 dark:text-gray-300 focus:outline-none focus:border-blue-500" placeholder="System Name">
                    <input type="color" id="currentSystemColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0" title="Change Color">
                </div>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 shrink-0 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center font-bold text-xl">&times;</button>
        </div>

        <div id="scoreGrid" class="grid grid-cols-3 gap-3 mb-6 max-h-[30vh] overflow-y-auto"></div>

        <div class="relative mb-6 flex gap-2 items-start">
            <textarea id="comment" class="flex-1 p-4 bg-gray-100 dark:bg-black/30 rounded-2xl h-20 text-sm font-bold resize-none outline-none focus:ring-2 ring-blue-500" placeholder="Comment..."></textarea>
            
            <div class="flex flex-col gap-2">
                <label class="w-12 h-12 rounded-xl flex items-center justify-center text-gray-400 bg-gray-100 dark:bg-black/30 hover:text-blue-500 cursor-pointer text-xl">
                    üì∑
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoSelect(event)">
                </label>
                <button id="deletePhotoBtn" onclick="removePhoto()" class="hidden w-12 h-8 rounded-xl items-center justify-center text-red-500 bg-red-100 hover:bg-red-200 text-xs font-bold">DEL</button>
            </div>
            <img id="photoPreview" class="photo-thumb absolute right-16 top-0 bg-white" alt="preview">
        </div>
        
        <div class="flex gap-3">
            <button onclick="moveWithoutSave(-1)" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-200 py-4 rounded-2xl font-black text-sm active:scale-95 transition-transform">
                <span class="block text-xs opacity-50 font-normal">NO SAVE</span>
                &lt; BACK
            </button>
            <button onclick="saveAndMove(1)" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-transform">
                SAVE & NEXT &gt;
            </button>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW fail', err));
        });
    }

    let state = JSON.parse(localStorage.getItem('field_eval_v4')) || {
        currentField: 'Field 1',
        gpsEnabled: false,
        theme: 'light',
        systemColors: {},
        fields: {
            'Field 1': { 
                config: {rows:4, lines:2, plants:5, maxScore:5}, 
                data: {}, 
                systems: {},
                meta: { date: '', surveyor: '', crop: '', lat: null, lon: null }
            }
        }
    };
    
    // „Éá„Éº„ÇøÊßãÈÄ†„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÔºàÂè§„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åã„Çâ„ÅÆÁßªË°åÁî®Ôºâ
    if(!state.fields[state.currentField].meta) {
        Object.keys(state.fields).forEach(k => {
            if(!state.fields[k].meta) state.fields[k].meta = { date: '', surveyor: '', crop: '', lat: null, lon: null };
        });
    }

    let currentScale = 1;
    let tempPhotoData = null;

    window.onload = () => {
        applyTheme(state.theme);
        updateSelector(); // „Çø„ÉñÊèèÁîª
        renderMap();
        updateProgress();
        initZoom();
    };

    function saveState() {
        localStorage.setItem('field_eval_v4', JSON.stringify(state));
        updateProgress();
    }

    /* Zoom Logic */
    function initZoom() {
        const container = document.getElementById('mapContainer');
        let initialDistance = 0; let initialScale = 1;
        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) { e.preventDefault(); initialDistance = getDistance(e.touches[0], e.touches[1]); initialScale = currentScale; }
        }, { passive: false });
        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) { e.preventDefault(); const dist = getDistance(e.touches[0], e.touches[1]); setZoom(initialScale * (dist/initialDistance)); }
        }, { passive: false });
        container.addEventListener('wheel', (e) => {
            if(e.shiftKey || e.ctrlKey) { e.preventDefault(); setZoom(currentScale + (e.deltaY * -0.001)); }
        }, { passive: false });
    }
    function getDistance(t1, t2) { return Math.hypot(t2.pageX - t1.pageX, t2.pageY - t1.pageY); }
    function setZoom(scale) {
        currentScale = Math.min(Math.max(scale, 0.5), 3.0);
        document.getElementById('fieldMap').style.transform = `scale(${currentScale})`;
        document.getElementById('zoomSlider').value = currentScale;
    }
    function manualZoom(val) { setZoom(parseFloat(val)); }

    /* Helper */
    function getSystemColor(name) {
        if(!name) return 'black';
        if(state.systemColors && state.systemColors[name]) return state.systemColors[name];
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash % 360);
        return `hsl(${h}, 70%, 40%)`; 
    }
    function rgbToHex(color) { return color.startsWith('#') ? color : '#000000'; }

    /* Map Rendering */
    function renderMap() {
        const field = state.fields[state.currentField];
        const { rows, lines, plants, maxScore } = field.config;
        const container = document.getElementById('fieldMap');
        container.innerHTML = '';

        for (let r = 1; r <= rows; r++) {
            const uneBlock = document.createElement('div');
            uneBlock.className = 'une-block';
            uneBlock.innerHTML = `<div class="une-header">R-${r}</div>`;
            for (let l = 1; l <= lines; l++) {
                const col = document.createElement('div');
                col.className = 'flex flex-col gap-3 min-w-[90px]';
                col.innerHTML = `<div class="text-center text-[10px] font-bold text-gray-400 uppercase">L${l}</div>`;
                for (let p = 1; p <= plants; p++) {
                    const id = `${r}-${l}-${p}`;
                    const d = field.data[id];
                    const sys = field.systems[id] || '';
                    const val = d ? d.score : null;
                    const hasPhoto = d && d.photo;
                    
                    const div = document.createElement('div');
                    div.id = `cell-${id}`;
                    div.className = 'plant-cell relative overflow-hidden group cursor-pointer';
                    if (val !== null && val !== 'RESET') {
                        div.style.backgroundColor = getHeatmapColor(val, maxScore);
                    }
                    const sysColor = state.theme === 'dark' && !state.systemColors[sys] ? '#cbd5e1' : getSystemColor(sys);

                    // ‰øÆÊ≠£ÁÇπ: Â∑¶‰∏ä„ÅÆÁï™Âè∑„ÇíÈªí„Éª2ÂÄç„Çµ„Ç§„Ç∫„Å´Â§âÊõ¥
                    div.innerHTML = `
                        <span class="absolute top-1 left-2 text-lg font-black opacity-80 text-black">#${p}</span>
                        ${hasPhoto ? '<span class="absolute top-1 right-1 text-xs">üì∑</span>' : ''}
                        <div class="w-full text-center px-1 text-[18px] font-black leading-tight mt-3 break-words overflow-hidden max-h-[50px]" style="color:${sysColor}">${sys}</div>
                        <span class="text-2xl font-black leading-none mt-1 text-gray-800 dark:text-gray-100">
                            ${val === 'Ë©ï‰æ°‰∏çËÉΩ' ? 'N/A' : (val === 'Ê¨†Ê†™' ? '√ó' : (val ?? ''))}
                        </span>
                    `;
                    div.onclick = () => openScoring(id);
                    col.appendChild(div);
                }
                uneBlock.appendChild(col);
            }
            container.appendChild(uneBlock);
        }
    }

    function getHeatmapColor(val, max) {
        if (val === 'Ë©ï‰æ°‰∏çËÉΩ') return state.theme==='dark' ? '#374151' : '#f3f4f6';
        if (val === 'Ê¨†Ê†™') return state.theme==='dark' ? '#7f1d1d' : '#fee2e2';
        if (!val) return '';
        const r = parseFloat(val) / max;
        const l = state.theme === 'dark' ? 20 + (r * 40) : 95 - (r * 50);
        return `hsl(142, 70%, ${l}%)`;
    }

    /* Scoring Modal */
    function openScoring(id) {
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = id;
        document.getElementById(`cell-${id}`).classList.add('selected');
        
        const f = state.fields[state.currentField];
        const d = f.data[id] || { score: null, comment: '' };
        const sysName = f.systems[id] || '';

        document.getElementById('inputModal').classList.remove('hidden');
        document.getElementById('currentIdLabel').innerText = id;
        document.getElementById('currentSystemInput').value = sysName;
        document.getElementById('currentSystemColor').value = rgbToHex(getSystemColor(sysName));
        document.getElementById('comment').value = d.comment || '';
        
        tempPhotoData = d.photo || null;
        updatePhotoPreview();

        const grid = document.getElementById('scoreGrid');
        grid.innerHTML = '';
        
        // ‰øÆÊ≠£ÁÇπ: „Çπ„Ç≥„Ç¢„Éú„Çø„É≥(Êï∞ÂÄ§)„ÇíÂÖà„Å´Ë°®Á§∫
        for (let s = 0; s <= f.config.maxScore; s += 0.5) {
             grid.innerHTML += `<div><input type="radio" name="score" id="s${s}" value="${s}" class="score-input hidden" ${d.score==s?'checked':''}><label for="s${s}" class="score-btn cursor-pointer">${s}</label></div>`;
        }
        
        // ‰øÆÊ≠£ÁÇπ: ÁâπÊÆä„Éú„Çø„É≥ÔºàRESET, Ê¨†Ê†™, Ë©ï‰æ°‰∏çËÉΩÔºâ„ÇíÊúÄÂæå„Å´ÁßªÂãï
        const specials = ['RESET', 'Ê¨†Ê†™', 'Ë©ï‰æ°‰∏çËÉΩ'];
        specials.forEach((opt, i) => {
            const label = opt === 'RESET' ? 'RESET<br>(Êú™Ë©ï‰æ°)' : opt;
            const cls = opt === 'RESET' ? 'reset-btn' : 'special-btn';
            grid.innerHTML += `<div class="col-span-1"><input type="radio" name="score" id="sp_${i}" value="${opt}" class="score-input hidden" ${d.score===opt?'checked':''}><label for="sp_${i}" class="score-btn ${cls} cursor-pointer text-xs">${label}</label></div>`;
        });
    }

    function handlePhotoSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = function(ev) {
            const img = new Image();
            img.onload = function() {
                const c = document.createElement('canvas');
                const scale = 600 / img.width;
                c.width = 600; c.height = img.height * scale;
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                tempPhotoData = c.toDataURL('image/jpeg', 0.7);
                updatePhotoPreview();
            };
            img.src = ev.target.result;
        };
        r.readAsDataURL(file);
    }
    function removePhoto() { if(confirm('Delete photo?')) { tempPhotoData = null; document.getElementById('photoInput').value = ''; updatePhotoPreview(); } }
    function updatePhotoPreview() {
        const p = document.getElementById('photoPreview');
        const b = document.getElementById('deletePhotoBtn');
        if(tempPhotoData) { p.src = tempPhotoData; p.classList.add('active'); b.classList.remove('hidden'); b.classList.add('flex'); }
        else { p.classList.remove('active'); p.src = ''; b.classList.add('hidden'); b.classList.remove('flex'); }
    }

    function saveAndMove(dir) {
        const input = document.querySelector('input[name="score"]:checked');
        if(!input) { alert("Please select a score or RESET."); return; }

        const newSys = document.getElementById('currentSystemInput').value;
        const newCol = document.getElementById('currentSystemColor').value;
        state.fields[state.currentField].systems[window.currentId] = newSys;
        state.systemColors[newSys] = newCol;

        if (input.value === 'RESET') {
            delete state.fields[state.currentField].data[window.currentId];
            saveState(); renderMap(); commit(null, dir, false); return;
        }

        const d = { score: input.value, comment: document.getElementById('comment').value, photo: tempPhotoData, timestamp: new Date().toISOString() };
        if (state.gpsEnabled && navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(
                 (p) => { d.lat = p.coords.latitude; d.lon = p.coords.longitude; commit(d, dir, true); },
                 () => { commit(d, dir, true); }, { enableHighAccuracy: true, timeout: 2000 }
             );
        } else commit(d, dir, true);
    }
    function moveWithoutSave(dir) { commit(null, dir, false); }
    function commit(obj, dir, save) {
        if(save && obj) { state.fields[state.currentField].data[window.currentId] = obj; saveState(); renderMap(); }
        const cur = document.getElementById(`cell-${window.currentId}`);
        const next = findNeighbor(cur, dir);
        if(next) { cur.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(() => openScoring(next.id.replace('cell-', '')), 50); }
        else { closeModal(); if(dir===1) alert("End of field."); }
    }
    function findNeighbor(cell, dir) {
        const all = Array.from(document.querySelectorAll('.plant-cell'));
        const idx = all.indexOf(cell);
        return all[idx + dir] || null;
    }
    function closeModal() {
        document.getElementById('inputModal').classList.add('hidden');
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = null;
    }

    /* Configuration & Metadata */
    function openConfig() {
        const f = state.fields[state.currentField];
        const c = f.config;
        const m = f.meta || {};
        ['rows','lines','plants','maxScore'].forEach(k => document.getElementById(`cfg_${k}`).value = c[k]);
        document.getElementById('cfg_useGPS').checked = state.gpsEnabled;
        document.getElementById('cfg_fieldName').value = state.currentField;
        
        // „É°„Çø„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        document.getElementById('meta_date').value = m.date || '';
        document.getElementById('meta_surveyor').value = m.surveyor || '';
        document.getElementById('meta_crop').value = m.crop || '';
        
        // Â†¥ÊâÄË°®Á§∫
        const locStat = document.getElementById('locationStatus');
        const link = document.getElementById('mapsLink');
        if(m.lat && m.lon) {
            locStat.innerText = `Saved: ${m.lat.toFixed(5)}, ${m.lon.toFixed(5)}`;
            link.href = `https://www.google.com/maps?q=${m.lat},${m.lon}`;
            link.classList.remove('hidden');
        } else {
            locStat.innerText = "Not set";
            link.classList.add('hidden');
        }
        
        document.getElementById('configModal').classList.remove('hidden');
    }

    function setCurrentLocation() {
        if(!navigator.geolocation) return alert("Geolocation is not supported.");
        navigator.geolocation.getCurrentPosition(pos => {
            const f = state.fields[state.currentField];
            if(!f.meta) f.meta = {};
            f.meta.lat = pos.coords.latitude;
            f.meta.lon = pos.coords.longitude;
            openConfig(); // UIÊõ¥Êñ∞
            alert("Location saved!");
        });
    }

    function saveFieldConfig() {
        state.gpsEnabled = document.getElementById('cfg_useGPS').checked;
        
        // „Éï„Ç£„Éº„É´„ÉâÂêçÂ§âÊõ¥Âá¶ÁêÜ
        const oldName = state.currentField;
        const newName = document.getElementById('cfg_fieldName').value.trim();
        if(newName && newName !== oldName) {
            if(state.fields[newName]) return alert("Field name already exists.");
            state.fields[newName] = state.fields[oldName];
            delete state.fields[oldName];
            state.currentField = newName;
        }

        const f = state.fields[state.currentField];
        ['rows','lines','plants','maxScore'].forEach(k => f.config[k] = parseFloat(document.getElementById(`cfg_${k}`).value));
        
        // „É°„Çø„Éá„Éº„Çø‰øùÂ≠ò
        if(!f.meta) f.meta = {};
        f.meta.date = document.getElementById('meta_date').value;
        f.meta.surveyor = document.getElementById('meta_surveyor').value;
        f.meta.crop = document.getElementById('meta_crop').value;

        saveState();
        document.getElementById('configModal').classList.add('hidden');
        updateSelector();
        renderMap();
    }
    
    function resetFieldData() {
        if(confirm(`‚ö†Ô∏è Clear all DATA for ${state.currentField}?`)) {
            state.fields[state.currentField].data = {};
            saveState(); renderMap(); updateProgress(); document.getElementById('configModal').classList.add('hidden');
        }
    }
    function deleteCurrentField() {
        if(Object.keys(state.fields).length <= 1) return alert("Cannot delete last field.");
        if(confirm(`Delete field "${state.currentField}"?`)) {
            delete state.fields[state.currentField];
            state.currentField = Object.keys(state.fields)[0];
            saveState(); updateSelector(); renderMap(); updateProgress(); document.getElementById('configModal').classList.add('hidden');
        }
    }

    /* Tab Switcher */
    function updateSelector() {
        const tabs = document.getElementById('tabs');
        tabs.innerHTML = '';
        Object.keys(state.fields).forEach(name => {
            const div = document.createElement('div');
            div.className = `tab-item ${name === state.currentField ? 'active' : ''}`;
            div.innerText = name;
            div.onclick = () => { state.currentField = name; saveState(); updateSelector(); renderMap(); updateProgress(); };
            tabs.appendChild(div);
        });
        // New Field Button
        const addBtn = document.createElement('div');
        addBtn.className = 'tab-item text-blue-500';
        addBtn.innerText = '+';
        addBtn.onclick = () => {
            const n = prompt("New Field Name:");
            if(n && !state.fields[n]) {
                state.fields[n] = { config: {rows:4, lines:2, plants:5, maxScore:5}, data:{}, systems:{}, meta:{date:'',surveyor:'',crop:''} };
                state.currentField = n;
                saveState(); updateSelector(); renderMap(); updateProgress();
            }
        };
        tabs.appendChild(addBtn);
    }
    
    /* Import Logic (‰øÆÊ≠£ÁÇπ: Ëá™ÂãïÊßãÊàê) */
    function importSystemNames(e) {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const lines = ev.target.result.split(/\r\n|\n/);
            let count = 0;
            let maxR=0, maxL=0, maxP=0;
            
            lines.forEach(l => {
                const parts = l.split(',');
                if(parts.length >= 2) {
                    const id = parts[0].trim(); // "1-2-3"
                    const name = parts[1].trim();
                    if(id && name) {
                        state.fields[state.currentField].systems[id] = name;
                        count++;
                        
                        // IDËß£Êûê„Åó„Å¶ÊúÄÂ§ßÂÄ§„ÇíÊõ¥Êñ∞
                        const nums = id.split('-').map(Number);
                        if(nums.length === 3) {
                            if(nums[0] > maxR) maxR = nums[0];
                            if(nums[1] > maxL) maxL = nums[1];
                            if(nums[2] > maxP) maxP = nums[2];
                        }
                    }
                }
            });
            
            // ÊßãÊàê„ÇíËá™ÂãïÊõ¥Êñ∞
            if(count > 0 && maxR > 0) {
                const c = state.fields[state.currentField].config;
                c.rows = maxR;
                c.lines = Math.max(c.lines, maxL); // ÁèæÂú®ÂÄ§„Çà„ÇäÂ§ß„Åç„Åë„Çå„Å∞Êõ¥Êñ∞
                c.plants = Math.max(c.plants, maxP);
                alert(`Imported ${count} systems.\nMap updated to Rows:${c.rows}, Lines:${c.lines}, Plants:${c.plants}`);
            }

            saveState();
            renderMap();
            e.target.value = '';
        };
        r.readAsText(file);
    }

    /* Export Logic (‰øÆÊ≠£ÁÇπ: „Éï„Ç£„Éº„É´„Éâ„Åî„Å®„Éª„É°„Çø„Éá„Éº„ÇøËøΩÂä†) */
    function exportData() {
        const fn = state.currentField;
        const f = state.fields[fn];
        const m = f.meta || {};
        
        // „É°„Çø„Éá„Éº„Çø„Éò„ÉÉ„ÉÄ„Éº
        let csv = `# Field: ${fn}\n# Date: ${m.date}\n# Surveyor: ${m.surveyor}\n# Crop: ${m.crop}\n# Location: ${m.lat},${m.lon}\n`;
        csv += "Field,ID,System,Score,Comment,Lat,Lon,Time,HasPhoto\n";
        
        for(const id in f.data) {
            const d = f.data[id];
            const hasP = d.photo ? 'Yes' : 'No';
            csv += `${fn},${id},${f.systems[id]||''},${d.score},"${d.comment}",${d.lat||''},${d.lon||''},${d.timestamp||''},${hasP}\n`;
        }
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv'}));
        a.download = `FieldEval_${fn}_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }

    /* Stats, Theme, Speech... (Unchanged logic) */
    function openStats() {
        const f = state.fields[state.currentField];
        const container = document.getElementById('statsContent');
        container.innerHTML = '';
        const systemStats = {};
        const allSystems = new Set(Object.values(f.systems));
        allSystems.forEach(sys => {
            if(!sys) return;
            systemStats[sys] = { counts: {}, total: 0, sum: 0 };
            for(let i=1; i<=f.config.maxScore; i++) systemStats[sys].counts[i] = 0;
            systemStats[sys].counts['N/A'] = 0; systemStats[sys].counts['Miss'] = 0;
        });
        for(const id in f.data) {
            const sys = f.systems[id];
            const score = f.data[id].score;
            if(sys && systemStats[sys]) {
                if(score === 'Ë©ï‰æ°‰∏çËÉΩ') systemStats[sys].counts['N/A']++;
                else if(score === 'Ê¨†Ê†™') systemStats[sys].counts['Miss']++;
                else {
                    const num = parseFloat(score);
                    if(!isNaN(num)) {
                        const key = Math.round(num);
                        if(systemStats[sys].counts[key] !== undefined) systemStats[sys].counts[key]++;
                        systemStats[sys].total++; systemStats[sys].sum += num;
                    }
                }
            }
        }
        if(Object.keys(systemStats).length === 0) container.innerHTML = '<div class="text-center text-gray-500 py-10">No data.</div>';
        else {
            Object.keys(systemStats).sort().forEach(sys => {
                const stat = systemStats[sys];
                const avg = stat.total > 0 ? (stat.sum / stat.total).toFixed(1) : '-';
                let barsHtml = '';
                let maxCount = 0; Object.values(stat.counts).forEach(c => maxCount = Math.max(maxCount, c));
                for(let i=1; i<=f.config.maxScore; i++) {
                    const count = stat.counts[i] || 0;
                    const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    barsHtml += `<div class="flex flex-col items-center flex-1"><div class="bar-container w-full items-end justify-center"><div class="bar w-full" style="height: ${height}%" data-count="${count}"></div></div><span class="text-[9px] mt-1 font-bold text-gray-400">${i}</span></div>`;
                }
                container.innerHTML += `<div class="bg-gray-50 dark:bg-black/20 p-4 rounded-xl"><div class="flex justify-between items-baseline mb-2"><h4 class="font-bold text-lg" style="color:${getSystemColor(sys)}">${sys}</h4><span class="text-xs font-bold text-gray-500">Avg: ${avg} (n=${stat.total})</span></div><div class="flex gap-2 h-16 items-end px-2">${barsHtml}</div></div>`;
            });
        }
        document.getElementById('statsModal').classList.remove('hidden');
    }
    function toggleTheme() { state.theme = state.theme === 'light' ? 'dark' : 'light'; applyTheme(state.theme); saveState(); renderMap(); }
    function applyTheme(t) { if(t === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }
    function updateProgress() {
        const f = state.fields[state.currentField];
        const total = f.config.rows * f.config.lines * f.config.plants;
        const done = Object.keys(f.data).length;
        const pct = Math.round((done / total) * 100);
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('progressText').innerText = `${pct}% DONE`;
    }
</script>
</body>
</html>