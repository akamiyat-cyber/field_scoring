<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FieldEval Outdoor V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { touch-action: manipulation; background-color: #e5e5e5; font-family: sans-serif; padding-bottom: 100px; }
        
        /* ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .tab-container { display: flex; gap: 4px; overflow-x: auto; padding: 4px 0; scrollbar-width: none; }
        .tab-btn { 
            white-space: nowrap; padding: 8px 16px; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 0.9rem;
            background: #525252; color: #a3a3a3; transition: all 0.2s;
        }
        .tab-btn.active { background: #e5e5e5; color: black; padding-bottom: 10px; margin-bottom: -4px; z-index: 10; }
        
        /* åœƒå ´ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .field-container { display: flex; gap: 50px; padding: 20px; overflow-x: auto; min-height: 80vh; align-items: flex-start; }
        .une-block { display: flex; gap: 15px; background: #d4d4d4; padding: 10px; border-radius: 8px; position: relative; padding-top: 45px; }
        .une-header { position: absolute; top: -5px; left: 0; width: 100%; text-align: center; font-size: 1.4rem; font-weight: 900; color: #333; background: rgba(255,255,255,0.6); padding: 2px 0; }
        .line-column { display: flex; flex-direction: column; gap: 12px; }

        /* å€‹ä½“ã‚»ãƒ«ï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºæ‹¡å¤§ï¼‰ */
        .plant-cell { 
            width: 100px; height: 100px; /* å°‘ã—å¤§ãã */
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 8px; background: white; border: 3px solid #666; transition: all 0.1s;
        }
        .selected { outline: 6px solid #ef4444 !important; outline-offset: -2px; z-index: 20; }
        .plant-id { font-size: 14px; font-weight: bold; opacity: 0.6; } /* ãƒ•ã‚©ãƒ³ãƒˆæ‹¡å¤§ */
        .system-name { font-size: 12px; font-weight: 900; width: 100%; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: #000; padding: 0 2px; } /* ãƒ•ã‚©ãƒ³ãƒˆæ‹¡å¤§ */
        .score-display { font-size: 28px; font-weight: 900; line-height: 1; margin-top: 4px; }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .score-btn { padding: 15px 0; font-size: 1.5rem; font-weight: bold; text-align: center; background: #fff; border: 3px solid #333; border-radius: 8px; }
        .score-input:checked + .score-btn { background: #16a34a; color: white; border-color: #fff; }
        .special-btn { background: #fee2e2; border-color: #991b1b; color: #991b1b; font-size: 1rem; display: flex; align-items: center; justify-content: center;}
        .score-input:checked + .special-btn { background: #991b1b; color: white; }

        /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .photo-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ccc; margin-bottom: 8px; display: none; }
        .photo-preview.show { display: block; }
    </style>
</head>
<body>

<div class="bg-black text-white pt-2 sticky top-0 z-50 shadow-md">
    <div class="flex justify-between items-center px-2 mb-2">
        <div class="flex items-center gap-2">
            <button onclick="location.href='./'" class="bg-gray-800 border border-gray-600 px-2 py-1 rounded text-xs font-bold hover:bg-gray-700">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <h1 class="text-xs font-bold text-gray-400 uppercase">FieldEval V2</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleViewMode()" id="viewModeBtn" class="bg-purple-700 border border-white px-3 py-1 rounded font-bold text-xs">ğŸ“Š ã‚°ãƒ©ãƒ•</button>
            <button onclick="document.getElementById('csvInput').click()" class="bg-gray-700 border border-white px-2 py-1 rounded font-bold text-xs">ç³»çµ±èª­è¾¼</button>
            <button onclick="openConfig()" class="bg-gray-700 border border-white px-2 py-1 rounded font-bold text-xs">è¨­å®š/ç®¡ç†</button>
            <button onclick="exportData()" class="bg-blue-800 border border-white px-2 py-1 rounded font-bold text-xs text-yellow-300">ä¿å­˜</button>
        </div>
        <input type="file" id="csvInput" class="hidden" accept=".csv" onchange="importSystemNames(event)">
    </div>
    
    <div class="flex items-end px-2 gap-2">
        <div id="fieldTabs" class="tab-container flex-grow">
            </div>
        <button onclick="addNewField()" class="text-white font-bold text-xl px-3 pb-2 hover:text-green-400">+</button>
    </div>
</div>

<div id="mainContainer" class="bg-[#e5e5e5]">
    <div id="fieldMap" class="field-container"></div>
    
    <div id="graphView" class="hidden p-4 min-h-[80vh] bg-white m-4 rounded-xl shadow-lg">
        <h2 class="text-xl font-black mb-4 text-center border-b pb-2">ç³»çµ±åˆ¥ã‚¹ã‚³ã‚¢å¹³å‡</h2>
        <canvas id="scoreChart"></canvas>
        <div id="noGraphData" class="hidden text-center text-gray-500 mt-10">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>
</div>

<div id="configModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl w-full max-w-sm border-4 border-gray-600 max-h-[90vh] overflow-y-auto">
        <h3 class="font-black text-2xl mb-4 border-b-2 border-black pb-2">è¨­å®šãƒ»ç®¡ç†</h3>
        
        <div class="bg-gray-100 p-3 rounded-lg mb-6 border border-gray-300">
            <label class="text-xs font-bold text-gray-500">ç¾åœ¨ã®åœƒå ´å</label>
            <div class="flex gap-2 mb-2">
                <input type="text" id="renameFieldInput" class="flex-grow border-2 border-gray-400 p-2 font-bold rounded">
                <button onclick="renameField()" class="bg-blue-600 text-white px-3 rounded font-bold">å¤‰æ›´</button>
            </div>
            <button onclick="deleteField()" class="w-full bg-red-100 text-red-600 border border-red-300 py-2 rounded font-bold text-sm">âš ï¸ ã“ã®åœƒå ´ã‚’å‰Šé™¤</button>
        </div>

        <div class="space-y-4 mb-6 text-lg font-bold">
            <div class="flex justify-between items-center">
                <span>GPSåº§æ¨™ã‚’è¨˜éŒ²</span>
                <input type="checkbox" id="cfg_useGPS" class="w-6 h-6 accent-blue-600">
            </div>
            <div class="border-t pt-4 mt-4">
                <p class="text-sm text-gray-500 mb-2">ãƒãƒƒãƒ—æ§‹é€ </p>
                <div class="flex justify-between items-center mb-2"><span>ç•æ•°</span><input type="number" id="cfg_rows" class="w-20 border-2 border-black p-1 text-center"></div>
                <div class="flex justify-between items-center mb-2"><span>æ¡æ•°</span><input type="number" id="cfg_lines" class="w-20 border-2 border-black p-1 text-center"></div>
                <div class="flex justify-between items-center mb-2"><span>å€‹ä½“æ•°</span><input type="number" id="cfg_plants" class="w-20 border-2 border-black p-1 text-center"></div>
                <div class="flex justify-between items-center"><span>è©•ä¾¡ä¸Šé™</span><input type="number" id="cfg_maxScore" class="w-20 border-2 border-black p-1 text-center"></div>
            </div>
        </div>
        <button onclick="saveFieldConfig()" class="w-full bg-black text-white py-4 rounded-lg font-black text-xl mb-3">è¨­å®šã‚’ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
        <button onclick="document.getElementById('configModal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-bold">åœƒå ´ãƒãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>
</div>

<div id="inputModal" class="modal-overlay hidden">
    <div class="bg-white w-[95%] max-w-md rounded-xl p-4 border-4 border-blue-600 shadow-2xl relative max-h-[95vh] overflow-y-auto">
        <button onclick="closeModal()" class="absolute top-2 right-2 bg-gray-200 w-10 h-10 rounded-full text-2xl font-bold text-gray-700 flex items-center justify-center z-10">&times;</button>
        
        <div class="mb-2">
            <div class="flex items-baseline gap-2">
                <span id="currentIdLabel" class="text-3xl font-black text-blue-800">1-1-1</span>
                <span id="currentSystemLabel" class="text-xl font-bold text-gray-800 truncate max-w-[200px]">System Name</span>
            </div>
        </div>

        <div class="mb-4 text-center">
            <img id="photoPreview" class="photo-preview mx-auto">
            <input type="file" id="photoInput" capture="environment" accept="image/*" class="hidden" onchange="handlePhotoSelect(event)">
            <button onclick="document.getElementById('photoInput').click()" class="bg-gray-100 text-gray-700 border-2 border-gray-400 w-full py-2 rounded-lg font-bold flex items-center justify-center gap-2">
                ğŸ“· å†™çœŸã‚’æ’®ã‚‹ / è¿½åŠ 
            </button>
            <button id="deletePhotoBtn" onclick="deletePhoto()" class="hidden text-red-500 text-xs font-bold mt-1 underline">å†™çœŸã‚’å‰Šé™¤</button>
        </div>

        <div id="scoreGrid" class="score-grid mb-4">
            </div>

        <textarea id="comment" class="w-full p-2 bg-gray-100 border-2 border-black rounded text-lg h-16 mb-3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ..."></textarea>
        
        <button onclick="saveAndNext()" class="w-full bg-blue-700 text-white border-2 border-white py-4 rounded-lg font-black text-2xl shadow-lg active:bg-blue-900">
            ä¿å­˜ã—ã¦æ¬¡ã¸
        </button>
    </div>
</div>

<script>
    // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ ---
    let state = JSON.parse(localStorage.getItem('field_eval_v5')) || {
        currentField: 'åœƒå ´1',
        gpsEnabled: false,
        fields: {
            'åœƒå ´1': { config: {rows:3, lines:2, plants:5, maxScore:5}, data: {}, systems: {} }
        }
    };
    
    // ç¾åœ¨ã®å…¥åŠ›ä¸­ã®å†™çœŸãƒ‡ãƒ¼ã‚¿ï¼ˆä¸€æ™‚ä¿æŒï¼‰
    let currentPhotoData = null;
    let chartInstance = null;

    window.onload = () => {
        renderTabs();
        renderMap();
    };

    function saveState() {
        try {
            localStorage.setItem('field_eval_v5', JSON.stringify(state));
        } catch (e) {
            alert('ä¿å­˜å®¹é‡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚å†™çœŸã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›ã—ã¦æ•´ç†ã—ã¦ãã ã•ã„ã€‚');
        }
    }

    // --- æç”»ç³» ---

    function getHeatmapColor(val, max) {
        if (val === 'æ¬ æ ª') return '#fee2e2'; 
        if (val === 'è©•ä¾¡ä¸èƒ½') return '#f3f4f6';
        if (val === null || val === undefined) return '#ffffff';
        const numVal = parseFloat(val);
        const lightness = 95 - (numVal / max * 60); 
        return `hsl(140, 70%, ${lightness}%)`;
    }

    function getTextColor(val, max) {
        if (val === 'æ¬ æ ª') return '#dc2626';
        if (val === 'è©•ä¾¡ä¸èƒ½') return '#6b7280';
        return (parseFloat(val) / max > 0.6) ? '#ffffff' : '#000000';
    }

    function renderTabs() {
        const container = document.getElementById('fieldTabs');
        container.innerHTML = '';
        Object.keys(state.fields).forEach(fname => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${fname === state.currentField ? 'active' : ''}`;
            btn.innerText = fname;
            btn.onclick = () => switchField(fname);
            container.appendChild(btn);
        });
    }

    function renderMap() {
        const field = state.fields[state.currentField];
        const { rows, lines, plants, maxScore } = field.config;
        const container = document.getElementById('fieldMap');
        container.innerHTML = '';

        for (let r = 1; r <= rows; r++) {
            const uneBlock = document.createElement('div');
            uneBlock.className = 'une-block';
            uneBlock.innerHTML = `<div class="une-header">${r} ç•</div>`;
            
            for (let l = 1; l <= lines; l++) {
                const lineCol = document.createElement('div');
                lineCol.className = 'line-column';
                lineCol.innerHTML = `<div class="text-center font-bold text-gray-600 mb-1">${l}æ¡</div>`;

                for (let p = 1; p <= plants; p++) {
                    const id = `${r}-${l}-${p}`;
                    const cellData = field.data[id];
                    const sysName = field.systems[id] || '';
                    const val = cellData ? cellData.score : null;
                    const hasPhoto = cellData && cellData.photo; // å†™çœŸãŒã‚ã‚‹ã‹

                    const div = document.createElement('div');
                    div.id = `cell-${id}`;
                    div.className = `plant-cell`;
                    
                    if (val !== null) {
                        div.style.backgroundColor = getHeatmapColor(val, maxScore);
                        div.style.color = getTextColor(val, maxScore);
                        div.style.borderColor = (val === 'æ¬ æ ª') ? '#dc2626' : '#15803d';
                    }

                    div.innerHTML = `
                        <span class="plant-id">${p}</span>
                        <div class="system-name">${sysName}</div>
                        <span class="score-display">
                            ${val === 'è©•ä¾¡ä¸èƒ½' ? 'N/A' : (val === 'æ¬ æ ª' ? 'Ã—' : (val ?? ''))}
                        </span>
                        ${hasPhoto ? '<span class="text-[10px] absolute bottom-1 right-1">ğŸ“·</span>' : ''}
                    `;
                    div.onclick = () => openScoring(id);
                    lineCol.appendChild(div);
                }
                uneBlock.appendChild(lineCol);
            }
            container.appendChild(uneBlock);
        }
    }

    // --- ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ ---
    function toggleViewMode() {
        const map = document.getElementById('fieldMap');
        const graph = document.getElementById('graphView');
        const btn = document.getElementById('viewModeBtn');

        if (map.classList.contains('hidden')) {
            map.classList.remove('hidden');
            graph.classList.add('hidden');
            btn.innerText = "ğŸ“Š ã‚°ãƒ©ãƒ•";
            btn.classList.remove('bg-gray-600');
            btn.classList.add('bg-purple-700');
        } else {
            map.classList.add('hidden');
            graph.classList.remove('hidden');
            btn.innerText = "ğŸ—º ãƒãƒƒãƒ—";
            btn.classList.remove('bg-purple-700');
            btn.classList.add('bg-gray-600');
            renderGraph();
        }
    }

    function renderGraph() {
        const field = state.fields[state.currentField];
        const sysScores = {}; // { 'ã‚³ã‚·ãƒ’ã‚«ãƒª': [5, 4.5, ...], ... }

        Object.keys(field.data).forEach(id => {
            const sys = field.systems[id] || '(ä¸æ˜)';
            const score = field.data[id].score;
            if (score && score !== 'æ¬ æ ª' && score !== 'è©•ä¾¡ä¸èƒ½') {
                if (!sysScores[sys]) sysScores[sys] = [];
                sysScores[sys].push(parseFloat(score));
            }
        });

        const labels = Object.keys(sysScores);
        if (labels.length === 0) {
            document.getElementById('noGraphData').classList.remove('hidden');
            if (chartInstance) chartInstance.destroy();
            return;
        }
        document.getElementById('noGraphData').classList.add('hidden');

        const averages = labels.map(sys => {
            const sum = sysScores[sys].reduce((a, b) => a + b, 0);
            return (sum / sysScores[sys].length);
        });

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆï¼ˆå¹³å‡ç‚¹ãŒé«˜ã„é †ï¼‰
        const combined = labels.map((l, i) => ({ label: l, val: averages[i] }));
        combined.sort((a, b) => b.val - a.val);

        const ctx = document.getElementById('scoreChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: combined.map(c => c.label),
                datasets: [{
                    label: 'å¹³å‡ã‚¹ã‚³ã‚¢',
                    data: combined.map(c => c.val),
                    backgroundColor: '#16a34a'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, max: field.config.maxScore } }
            }
        });
    }


    // --- å…¥åŠ›ãƒ»å†™çœŸ ---

    function openScoring(id) {
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = id;
        document.getElementById(`cell-${id}`).classList.add('selected');
        
        const field = state.fields[state.currentField];
        const data = field.data[id] || { score: null, comment: '', photo: null };

        document.getElementById('inputModal').classList.remove('hidden');
        document.getElementById('currentIdLabel').innerText = id;
        document.getElementById('currentSystemLabel').innerText = field.systems[id] || 'åç§°ãªã—';
        
        // ã‚¹ã‚³ã‚¢ãƒœã‚¿ãƒ³
        const grid = document.getElementById('scoreGrid');
        grid.innerHTML = '';
        ['æ¬ æ ª', 'è©•ä¾¡ä¸èƒ½'].forEach((opt, idx) => {
             grid.innerHTML += `
                <div>
                    <input type="radio" name="score" id="sp_${idx}" value="${opt}" class="score-input hidden" ${data.score === opt ? 'checked' : ''}>
                    <label for="sp_${idx}" class="score-btn special-btn h-full cursor-pointer">${opt}</label>
                </div>`;
        });
        for (let s = 0; s <= field.config.maxScore; s += 0.5) {
            grid.innerHTML += `
                <div>
                    <input type="radio" name="score" id="s${s}" value="${s}" class="score-input hidden" ${data.score == s ? 'checked' : ''}>
                    <label for="s${s}" class="score-btn block cursor-pointer">${s}</label>
                </div>`;
        }
        
        document.getElementById('comment').value = data.comment;
        
        // å†™çœŸè¡¨ç¤º
        currentPhotoData = data.photo || null;
        updatePhotoPreview();
    }

    function handlePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // ç”»åƒåœ§ç¸®å‡¦ç† (Canvasä½¿ç”¨)
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                // æœ€å¤§å¹… 600px ã«ãƒªã‚µã‚¤ã‚º
                const maxWidth = 600;
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // JPEG å“è³ª 0.6 ã§åœ§ç¸®
                currentPhotoData = canvas.toDataURL('image/jpeg', 0.6);
                updatePhotoPreview();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function updatePhotoPreview() {
        const img = document.getElementById('photoPreview');
        const delBtn = document.getElementById('deletePhotoBtn');
        if (currentPhotoData) {
            img.src = currentPhotoData;
            img.classList.add('show');
            delBtn.classList.remove('hidden');
        } else {
            img.classList.remove('show');
            delBtn.classList.add('hidden');
            document.getElementById('photoInput').value = '';
        }
    }

    function deletePhoto() {
        if(confirm("å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            currentPhotoData = null;
            updatePhotoPreview();
        }
    }

    function saveAndNext() {
        const scoreInput = document.querySelector('input[name="score"]:checked');
        if(!scoreInput) return alert("ã‚¹ã‚³ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„");

        const dataObj = {
            score: scoreInput.value,
            comment: document.getElementById('comment').value,
            photo: currentPhotoData,
            timestamp: new Date().toISOString()
        };

        if (state.gpsEnabled && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                dataObj.lat = pos.coords.latitude;
                dataObj.lon = pos.coords.longitude;
                commitSave(dataObj);
            }, () => commitSave(dataObj), { timeout: 3000 });
        } else {
            commitSave(dataObj);
        }
    }

    function commitSave(dataObj) {
        state.fields[state.currentField].data[window.currentId] = dataObj;
        saveState();
        renderMap();
        
        // è‡ªå‹•é·ç§»
        const currentCell = document.getElementById(`cell-${window.currentId}`);
        let next = currentCell.nextElementSibling;
        if(!next) {
             const currentLine = currentCell.parentElement;
             const nextLine = currentLine.nextElementSibling;
             if (nextLine?.classList.contains('line-column')) next = nextLine.querySelector('.plant-cell');
             else {
                 const nextUne = currentLine.parentElement.nextElementSibling;
                 if(nextUne) next = nextUne.querySelector('.plant-cell');
             }
        }

        if(next) {
            setTimeout(() => openScoring(next.id.replace('cell-', '')), 100);
        } else {
            closeModal();
            alert("çµ‚äº†");
        }
    }

    function closeModal() {
        document.getElementById('inputModal').classList.add('hidden');
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = null;
    }

    // --- ç®¡ç†ãƒ»è¨­å®š ---

    function addNewField() {
        const name = prompt("æ–°ã—ã„åœƒå ´å:");
        if(name && !state.fields[name]) {
            state.fields[name] = { config: {rows:3, lines:2, plants:5, maxScore:5}, data:{}, systems:{} };
            switchField(name);
        }
    }

    function switchField(name) {
        state.currentField = name;
        saveState();
        renderTabs();
        renderMap();
        // ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°
        if (!document.getElementById('graphView').classList.contains('hidden')) {
            renderGraph();
        }
    }

    function openConfig() {
        const cfg = state.fields[state.currentField].config;
        document.getElementById('renameFieldInput').value = state.currentField;
        document.getElementById('cfg_useGPS').checked = state.gpsEnabled;
        document.getElementById('cfg_rows').value = cfg.rows;
        document.getElementById('cfg_lines').value = cfg.lines;
        document.getElementById('cfg_plants').value = cfg.plants;
        document.getElementById('cfg_maxScore').value = cfg.maxScore;
        document.getElementById('configModal').classList.remove('hidden');
    }

    function renameField() {
        const newName = document.getElementById('renameFieldInput').value.trim();
        const oldName = state.currentField;
        if (!newName || newName === oldName) return;
        if (state.fields[newName]) return alert('ãã®åå‰ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');

        state.fields[newName] = state.fields[oldName];
        delete state.fields[oldName];
        state.currentField = newName;
        saveState();
        alert('å¤‰æ›´ã—ã¾ã—ãŸ');
        renderTabs();
    }

    function deleteField() {
        const name = state.currentField;
        if (Object.keys(state.fields).length <= 1) return alert('æœ€å¾Œã®1ã¤ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
        if (!confirm(`æœ¬å½“ã«ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚`)) return;

        delete state.fields[name];
        state.currentField = Object.keys(state.fields)[0];
        saveState();
        document.getElementById('configModal').classList.add('hidden');
        renderTabs();
        renderMap();
    }

    function saveFieldConfig() {
        state.gpsEnabled = document.getElementById('cfg_useGPS').checked;
        const f = state.fields[state.currentField];
        f.config.rows = parseInt(document.getElementById('cfg_rows').value);
        f.config.lines = parseInt(document.getElementById('cfg_lines').value);
        f.config.plants = parseInt(document.getElementById('cfg_plants').value);
        f.config.maxScore = parseFloat(document.getElementById('cfg_maxScore').value);
        saveState();
        document.getElementById('configModal').classList.add('hidden');
        renderMap();
    }

    function importSystemNames(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n');
            lines.forEach(line => {
                const [id, name] = line.split(',');
                if(id && name) state.fields[state.currentField].systems[id.trim()] = name.trim();
            });
            saveState();
            renderMap();
            alert('èª­è¾¼å®Œäº†');
        };
        reader.readAsText(file);
    }

    function exportData() {
        let csv = "åœƒå ´,åº§æ¨™,ç³»çµ±å,ã‚¹ã‚³ã‚¢,ã‚³ãƒ¡ãƒ³ãƒˆ,å†™çœŸæœ‰ç„¡,ç·¯åº¦,çµŒåº¦,æ—¥æ™‚\n";
        Object.keys(state.fields).forEach(fname => {
            const f = state.fields[fname];
            for (const id in f.data) {
                const d = f.data[id];
                const hasPhoto = d.photo ? 'ã‚ã‚Š' : '';
                csv += `${fname},${id},${f.systems[id]||''},${d.score},"${d.comment}",${hasPhoto},${d.lat||''},${d.lon||''},${d.timestamp||''}\n`;
            }
        });
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `FieldData_V2_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }
</script>
</body>
</html>