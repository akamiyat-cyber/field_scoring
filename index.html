<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FieldEval World Edition v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' }
                    }
                }
            }
        }
    </script>
    <style>
        /* 1æœ¬æŒ‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ã—ã¤ã¤ã€ãƒ”ãƒ³ãƒæ“ä½œã¯JSã§åˆ¶å¾¡ */
        body { overscroll-behavior: none; }
        
        #mapContainer {
            overflow: auto;
            width: 100%;
            height: calc(100vh - 140px);
            touch-action: pan-x pan-y;
            position: relative;
            background-color: #f3f4f6;
        }
        .dark #mapContainer { background-color: #0f172a; }

        #fieldMap { 
            display: flex; gap: 40px; padding: 40px;
            align-items: flex-start;
            transform-origin: 0 0;
            width: max-content;
        }

        .une-block {
            display: flex; gap: 12px;
            background: rgba(200, 200, 200, 0.2);
            border: 2px dashed #cbd5e1;
            padding: 40px 10px 10px 10px;
            border-radius: 16px; position: relative;
        }
        .dark .une-block { background: rgba(30, 41, 59, 0.5); border-color: #475569; }

        .une-header {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: white; padding: 4px 16px;
            border-radius: 20px; font-weight: 900; font-size: 0.9rem;
            white-space: nowrap; z-index: 5;
        }
        .dark .une-header { background: #3b82f6; }

        .plant-cell { 
            width: 90px; height: 100px;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            border-radius: 14px; background: white; 
            border: 2px solid #e2e8f0; 
            transition: transform 0.1s, border-color 0.1s;
        }
        .dark .plant-cell { background: #1e293b; border-color: #334155; color: white; }
        .selected { outline: 4px solid #3b82f6 !important; transform: scale(1.1); z-index: 20; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãƒãƒ¼ */
        .bar-container { display: flex; align-items: flex-end; height: 60px; gap: 2px; }
        .bar { flex: 1; background: #3b82f6; border-radius: 2px 2px 0 0; min-width: 8px; position: relative; }
        .bar:hover::after { content: attr(data-count); position: absolute; top: -20px; left: 0; right: 0; text-align: center; font-size: 10px; font-weight: bold; color: #3b82f6; }

        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .score-btn { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; border-radius: 12px; background: white; border: 2px solid #e2e8f0; color: #334155; }
        .dark .score-btn { background: #0f172a; border-color: #334155; color: #cbd5e1; }
        .score-input:checked + .score-btn { background: #2563eb; color: white; border-color: #2563eb; }
        .special-btn { font-size: 0.9rem; border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
        .score-input:checked + .special-btn { background: #dc2626; color: white; border-color: #dc2626; }
        
        /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .photo-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ccc; display: none; }
        .photo-thumb.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 dark:bg-dark-bg dark:text-gray-100 transition-colors duration-300 flex flex-col h-screen overflow-hidden">

<div class="bg-white dark:bg-dark-surface py-2 text-center border-b dark:border-dark-border z-50 shadow-sm shrink-0">
    <h1 class="text-xl font-black tracking-tight text-slate-900 dark:text-white">FieldEval <span class="text-blue-600">Pro</span></h1>
</div>

<div class="bg-white/90 dark:bg-dark-bg/95 backdrop-blur border-b border-gray-200 dark:border-dark-border z-40 shrink-0">
    <div class="h-1 w-full bg-gray-200 dark:bg-gray-800"><div id="progressBar" class="h-full bg-blue-600 transition-all duration-500 w-0"></div></div>
    
    <div class="flex justify-between items-center p-2 max-w-7xl mx-auto overflow-x-auto gap-4">
        <div class="flex flex-col min-w-[120px]">
            <select id="fieldSelector" onchange="switchField()" class="bg-transparent font-black text-lg outline-none cursor-pointer"></select>
            <span id="progressText" class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">0% DONE</span>
        </div>

        <div class="flex items-center gap-2">
            <input type="range" min="0.5" max="2.0" step="0.1" value="1.0" id="zoomSlider" oninput="manualZoom(this.value)" class="w-20 accent-blue-600 hidden sm:block">
            <button onclick="openStats()" class="p-2 rounded-lg bg-gray-100 dark:bg-dark-surface font-bold text-xs flex items-center gap-1 whitespace-nowrap"><span>ğŸ“Š</span> Stats</button>
            <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-dark-surface">ğŸŒ—</button>
            <button onclick="openConfig()" class="p-2 rounded-lg bg-gray-100 dark:bg-dark-surface font-bold text-xs">âš™ï¸</button>
            
            <label class="p-2 rounded-lg bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 font-bold text-xs cursor-pointer flex items-center gap-1 hover:opacity-80 transition-opacity">
                <span>ğŸ“¥</span> Import
                <input type="file" accept=".csv,.txt" class="hidden" onchange="importSystemNames(event)">
            </label>

            <button onclick="exportData()" class="p-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-lg">Export</button>
        </div>
    </div>
</div>

<div id="mapContainer" class="flex-1">
    <div id="fieldMap"></div>
</div>

<footer class="bg-gray-200 dark:bg-black py-2 text-center text-[10px] text-gray-500 dark:text-gray-600 font-bold shrink-0 z-50">
    Created by Takehiro Kamiya (University of Tokyo) | Use at your own risk.
</footer>

<div id="statsModal" class="hidden fixed inset-0 bg-black/80 z-[70] flex flex-col p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl flex-1 max-w-2xl mx-auto w-full flex flex-col overflow-hidden">
        <div class="p-4 border-b dark:border-dark-border flex justify-between items-center">
            <h3 class="font-black text-xl">ğŸ“Š System Analysis</h3>
            <button onclick="document.getElementById('statsModal').classList.add('hidden')" class="text-2xl font-bold text-gray-400">&times;</button>
        </div>
        <div id="statsContent" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
    </div>
</div>

<div id="configModal" class="hidden fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-dark-surface p-6 rounded-2xl w-full max-w-sm shadow-2xl">
        <h3 class="font-black text-2xl mb-6">Setup (è¨­å®š)</h3>
        <div class="space-y-4 font-bold text-sm">
            <label class="flex justify-between items-center p-3 bg-gray-50 dark:bg-black/20 rounded-xl">
                <span>ğŸ“ GPS Record (ä½ç½®æƒ…å ±è¨˜éŒ²)</span>
                <input type="checkbox" id="cfg_useGPS" class="w-6 h-6 accent-blue-600">
            </label>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-gray-400 text-xs">Rows (ç•æ•°)</label><input type="number" id="cfg_rows" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Lines (æ¡æ•°)</label><input type="number" id="cfg_lines" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Plants (å€‹ä½“æ•°/æ¡)</label><input type="number" id="cfg_plants" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
                <div><label class="text-gray-400 text-xs">Max Score (æœ€å¤§å€¤)</label><input type="number" id="cfg_maxScore" class="w-full bg-gray-100 dark:bg-black/20 p-2 rounded-lg text-center font-black"></div>
            </div>
            
            <div class="pt-4 border-t dark:border-dark-border">
                <button onclick="deleteCurrentField()" class="w-full py-2 text-red-500 font-bold hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors text-xs">
                    ğŸ—‘ï¸ Delete This Field (ã“ã®åœƒå ´ã‚’å‰Šé™¤)
                </button>
            </div>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="document.getElementById('configModal').classList.add('hidden')" class="flex-1 py-4 font-bold text-gray-400">Cancel</button>
            <button onclick="saveFieldConfig()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold">Save</button>
        </div>
    </div>
</div>

<div id="inputModal" class="fixed inset-0 z-[100] hidden flex flex-col justify-end sm:justify-center items-center bg-black/60 backdrop-blur-sm">
    <div class="absolute inset-0" onclick="closeModal()"></div>
    <div class="modal-enter relative w-full sm:w-[400px] bg-white dark:bg-dark-surface sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl border-t border-white/20">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 id="currentIdLabel" class="text-4xl font-black text-blue-600 dark:text-blue-400 leading-none">--</h2>
                <p id="currentSystemLabel" class="text-sm font-bold text-gray-500 mt-1 truncate max-w-[250px]">No Data</p>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center font-bold text-xl">&times;</button>
        </div>

        <div id="scoreGrid" class="grid grid-cols-3 gap-3 mb-6 max-h-[30vh] overflow-y-auto"></div>

        <div class="relative mb-6 flex gap-2 items-start">
            <textarea id="comment" class="flex-1 p-4 bg-gray-100 dark:bg-black/30 rounded-2xl h-20 text-sm font-bold resize-none outline-none focus:ring-2 ring-blue-500" placeholder="Comment..."></textarea>
            
            <div class="flex flex-col gap-2">
                <button id="micBtn" onclick="toggleSpeech()" class="w-12 h-9 rounded-xl flex items-center justify-center text-gray-400 bg-gray-100 dark:bg-black/30 hover:text-blue-500">ğŸ¤</button>
                <label class="w-12 h-9 rounded-xl flex items-center justify-center text-gray-400 bg-gray-100 dark:bg-black/30 hover:text-blue-500 cursor-pointer">
                    ğŸ“·
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoSelect(event)">
                </label>
            </div>
            <img id="photoPreview" class="photo-thumb absolute right-16 top-0 bg-white" alt="preview">
        </div>
        
        <div class="flex gap-3">
            <button onclick="moveWithoutSave(-1)" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-200 py-4 rounded-2xl font-black text-sm active:scale-95 transition-transform">
                <span class="block text-xs opacity-50 font-normal">NO SAVE</span>
                &lt; BACK
            </button>
            <button onclick="saveAndMove(1)" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-transform">
                SAVE & NEXT &gt;
            </button>
        </div>
    </div>
</div>

<script>
    let state = JSON.parse(localStorage.getItem('field_eval_world_v3')) || {
        currentField: 'Field 1',
        gpsEnabled: false,
        theme: 'light',
        fields: {
            'Field 1': { config: {rows:4, lines:2, plants:5, maxScore:5}, data: {}, systems: {} }
        }
    };
    
    let currentScale = 1;
    let recognition = null;
    let tempPhotoData = null;

    window.onload = () => {
        applyTheme(state.theme);
        document.getElementById('cfg_useGPS').checked = state.gpsEnabled;
        updateSelector();
        renderMap();
        updateProgress();
        initSpeech();
        initZoom();
    };

    function saveState() {
        localStorage.setItem('field_eval_world_v3', JSON.stringify(state));
        updateProgress();
    }

    /* ----- 1. Zoom Logic ----- */
    function initZoom() {
        const container = document.getElementById('mapContainer');
        let initialDistance = 0;
        let initialScale = 1;
        container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                initialDistance = getDistance(e.touches[0], e.touches[1]);
                initialScale = currentScale;
            }
        }, { passive: false });
        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = getDistance(e.touches[0], e.touches[1]);
                const delta = dist / initialDistance;
                setZoom(initialScale * delta);
            }
        }, { passive: false });
        container.addEventListener('wheel', (e) => {
            if(e.shiftKey || e.ctrlKey) {
                e.preventDefault();
                setZoom(currentScale + (e.deltaY * -0.001));
            }
        }, { passive: false });
    }
    function getDistance(t1, t2) { return Math.hypot(t2.pageX - t1.pageX, t2.pageY - t1.pageY); }
    function setZoom(scale) {
        currentScale = Math.min(Math.max(scale, 0.5), 3.0);
        document.getElementById('fieldMap').style.transform = `scale(${currentScale})`;
        const slider = document.getElementById('zoomSlider');
        if(slider) slider.value = currentScale;
    }
    function manualZoom(val) { setZoom(parseFloat(val)); }

    /* ----- Analytics ----- */
    function openStats() {
        const field = state.fields[state.currentField];
        const container = document.getElementById('statsContent');
        container.innerHTML = '';
        const systemStats = {};
        const allSystems = new Set(Object.values(field.systems));
        
        allSystems.forEach(sys => {
            if(!sys) return;
            systemStats[sys] = { counts: {}, total: 0, sum: 0 };
            for(let i=1; i<=field.config.maxScore; i++) systemStats[sys].counts[i] = 0;
            systemStats[sys].counts['N/A'] = 0;
            systemStats[sys].counts['Miss'] = 0;
        });

        for(const id in field.data) {
            const sys = field.systems[id];
            const score = field.data[id].score;
            if(sys && systemStats[sys]) {
                if(score === 'è©•ä¾¡ä¸èƒ½') systemStats[sys].counts['N/A']++;
                else if(score === 'æ¬ æ ª') systemStats[sys].counts['Miss']++;
                else {
                    const num = parseFloat(score);
                    if(!isNaN(num)) {
                        const key = Math.round(num);
                        if(systemStats[sys].counts[key] !== undefined) systemStats[sys].counts[key]++;
                        systemStats[sys].total++;
                        systemStats[sys].sum += num;
                    }
                }
            }
        }

        if(Object.keys(systemStats).length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-10">No data.</div>';
        } else {
            Object.keys(systemStats).sort().forEach(sys => {
                const stat = systemStats[sys];
                const avg = stat.total > 0 ? (stat.sum / stat.total).toFixed(1) : '-';
                let barsHtml = '';
                let maxCount = 0;
                Object.values(stat.counts).forEach(c => { if(c > maxCount) maxCount = c; });

                for(let i=1; i<=field.config.maxScore; i++) {
                    const count = stat.counts[i] || 0;
                    const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    barsHtml += `<div class="flex flex-col items-center flex-1"><div class="bar-container w-full items-end justify-center"><div class="bar w-full" style="height: ${height}%" data-count="${count}"></div></div><span class="text-[9px] mt-1 font-bold text-gray-400">${i}</span></div>`;
                }
                container.innerHTML += `<div class="bg-gray-50 dark:bg-black/20 p-4 rounded-xl"><div class="flex justify-between items-baseline mb-2"><h4 class="font-bold text-lg text-blue-800 dark:text-blue-400">${sys}</h4><span class="text-xs font-bold text-gray-500">Avg: ${avg} (n=${stat.total})</span></div><div class="flex gap-2 h-16 items-end px-2">${barsHtml}</div></div>`;
            });
        }
        document.getElementById('statsModal').classList.remove('hidden');
    }

    /* ----- Render Map ----- */
    function renderMap() {
        const field = state.fields[state.currentField];
        const { rows, lines, plants, maxScore } = field.config;
        const container = document.getElementById('fieldMap');
        container.innerHTML = '';

        for (let r = 1; r <= rows; r++) {
            const uneBlock = document.createElement('div');
            uneBlock.className = 'une-block';
            uneBlock.innerHTML = `<div class="une-header">R-${r}</div>`;
            for (let l = 1; l <= lines; l++) {
                const col = document.createElement('div');
                col.className = 'flex flex-col gap-3 min-w-[90px]';
                col.innerHTML = `<div class="text-center text-[10px] font-bold text-gray-400 uppercase">L${l}</div>`;
                for (let p = 1; p <= plants; p++) {
                    const id = `${r}-${l}-${p}`;
                    const d = field.data[id];
                    const sys = field.systems[id] || '';
                    const val = d ? d.score : null;
                    const hasPhoto = d && d.photo;
                    
                    const div = document.createElement('div');
                    div.id = `cell-${id}`;
                    div.className = 'plant-cell relative overflow-hidden group cursor-pointer';
                    if (val !== null) {
                        div.style.backgroundColor = getHeatmapColor(val, maxScore);
                    }
                    div.innerHTML = `
                        <span class="absolute top-1 left-2 text-[9px] font-bold opacity-50 text-gray-800 dark:text-gray-300">#${p}</span>
                        ${hasPhoto ? '<span class="absolute top-1 right-1 text-xs">ğŸ“·</span>' : ''}
                        <div class="w-full text-center px-1 text-[18px] font-black text-black leading-tight mt-3 break-words overflow-hidden max-h-[50px]">${sys}</div>
                        <span class="text-2xl font-black leading-none mt-1 text-gray-800 dark:text-gray-100">
                            ${val === 'è©•ä¾¡ä¸èƒ½' ? 'N/A' : (val === 'æ¬ æ ª' ? 'Ã—' : (val ?? ''))}
                        </span>
                    `;
                    div.onclick = () => openScoring(id);
                    col.appendChild(div);
                }
                uneBlock.appendChild(col);
            }
            container.appendChild(uneBlock);
        }
    }

    function getHeatmapColor(val, max) {
        if (val === 'è©•ä¾¡ä¸èƒ½') return state.theme==='dark' ? '#374151' : '#f3f4f6';
        if (val === 'æ¬ æ ª') return state.theme==='dark' ? '#7f1d1d' : '#fee2e2';
        if (!val) return '';
        const r = parseFloat(val) / max;
        const l = state.theme === 'dark' ? 20 + (r * 40) : 95 - (r * 50);
        return `hsl(142, 70%, ${l}%)`;
    }

    /* ----- Scoring & Photo ----- */
    function openScoring(id) {
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = id;
        document.getElementById(`cell-${id}`).classList.add('selected');
        
        const f = state.fields[state.currentField];
        const d = f.data[id] || { score: null, comment: '' };

        document.getElementById('inputModal').classList.remove('hidden');
        document.getElementById('currentIdLabel').innerText = id;
        document.getElementById('currentSystemLabel').innerText = f.systems[id] || 'No System Name';
        document.getElementById('comment').value = d.comment || '';
        
        tempPhotoData = d.photo || null;
        const preview = document.getElementById('photoPreview');
        document.getElementById('photoInput').value = '';
        if(tempPhotoData) { preview.src = tempPhotoData; preview.classList.add('active'); }
        else { preview.classList.remove('active'); preview.src = ''; }

        const grid = document.getElementById('scoreGrid');
        grid.innerHTML = '';
        ['æ¬ æ ª', 'è©•ä¾¡ä¸èƒ½'].forEach((opt, i) => {
            grid.innerHTML += `<div class="col-span-1"><input type="radio" name="score" id="sp_${i}" value="${opt}" class="score-input hidden" ${d.score===opt?'checked':''}><label for="sp_${i}" class="score-btn special-btn cursor-pointer text-xs">${opt}</label></div>`;
        });
        for (let s = 0; s <= f.config.maxScore; s += 0.5) {
             grid.innerHTML += `<div><input type="radio" name="score" id="s${s}" value="${s}" class="score-input hidden" ${d.score==s?'checked':''}><label for="s${s}" class="score-btn cursor-pointer">${s}</label></div>`;
        }
    }

    function handlePhotoSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600;
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                tempPhotoData = canvas.toDataURL('image/jpeg', 0.7);
                const preview = document.getElementById('photoPreview');
                preview.src = tempPhotoData;
                preview.classList.add('active');
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    function saveAndMove(dir) {
        const input = document.querySelector('input[name="score"]:checked');
        if(!input) return alert("Please select a score.");
        const d = { 
            score: input.value, 
            comment: document.getElementById('comment').value, 
            photo: tempPhotoData, 
            timestamp: new Date().toISOString() 
        };
        if (state.gpsEnabled && navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(
                 (p) => { d.lat = p.coords.latitude; d.lon = p.coords.longitude; commit(d, dir, true); },
                 () => { commit(d, dir, true); }, { enableHighAccuracy: true, timeout: 2000 }
             );
        } else commit(d, dir, true);
    }
    function moveWithoutSave(dir) { commit(null, dir, false); }
    function commit(dataObj, dir, shouldSave) {
        if(shouldSave && dataObj) {
            state.fields[state.currentField].data[window.currentId] = dataObj;
            saveState(); renderMap();
        }
        const current = document.getElementById(`cell-${window.currentId}`);
        const next = findNeighbor(current, dir);
        if(next) {
            current.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
            setTimeout(() => { openScoring(next.id.replace('cell-', '')); }, 50);
        } else {
            closeModal();
            if(dir === 1) alert("End of field reached.");
        }
    }
    function findNeighbor(cell, dir) {
        if(!cell) return null;
        const all = Array.from(document.querySelectorAll('.plant-cell'));
        const idx = all.indexOf(cell);
        if(idx === -1) return null;
        return all[idx + dir] || null;
    }
    function closeModal() {
        document.getElementById('inputModal').classList.add('hidden');
        if(window.currentId) document.getElementById(`cell-${window.currentId}`)?.classList.remove('selected');
        window.currentId = null;
        tempPhotoData = null;
    }

    /* ----- Utilities & IO ----- */
    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme(state.theme); saveState(); renderMap();
    }
    function applyTheme(t) {
        if(t === 'dark') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
    }
    function updateProgress() {
        const f = state.fields[state.currentField];
        const total = f.config.rows * f.config.lines * f.config.plants;
        const done = Object.keys(f.data).length;
        const pct = Math.round((done / total) * 100);
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('progressText').innerText = `${pct}% DONE`;
    }
    function initSpeech() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.lang = 'ja-JP';
            recognition.onresult = (e) => {
                const t = e.results[0][0].transcript;
                const ta = document.getElementById('comment');
                ta.value = (ta.value + ' ' + t).trim();
                stopSpeech();
            };
            recognition.onerror = stopSpeech; recognition.onend = stopSpeech;
        } else document.getElementById('micBtn').style.display = 'none';
    }
    function toggleSpeech() {
        const btn = document.getElementById('micBtn');
        if(btn.style.color === 'red') recognition.stop();
        else { btn.style.color = 'red'; recognition.start(); }
    }
    function stopSpeech() { document.getElementById('micBtn').style.color = ''; }

    function openConfig() {
        const cfg = state.fields[state.currentField].config;
        ['rows','lines','plants','maxScore'].forEach(k => document.getElementById(`cfg_${k}`).value = cfg[k]);
        document.getElementById('configModal').classList.remove('hidden');
    }
    function saveFieldConfig() {
        state.gpsEnabled = document.getElementById('cfg_useGPS').checked;
        const f = state.fields[state.currentField];
        ['rows','lines','plants','maxScore'].forEach(k => f.config[k] = parseFloat(document.getElementById(`cfg_${k}`).value));
        saveState();
        document.getElementById('configModal').classList.add('hidden');
        renderMap();
    }
    
    // è¿½åŠ æ©Ÿèƒ½: åœƒå ´å‰Šé™¤
    function deleteCurrentField() {
        const fieldName = state.currentField;
        if(Object.keys(state.fields).length <= 1) {
            alert("This is the only field available. Cannot delete.\n(æœ€å¾Œã®1ã¤ã®åœƒå ´ã¯å‰Šé™¤ã§ãã¾ã›ã‚“)");
            return;
        }
        if(confirm(`Are you sure you want to delete "${fieldName}"?\nThis cannot be undone.\n\næœ¬å½“ã« "${fieldName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
            delete state.fields[fieldName];
            state.currentField = Object.keys(state.fields)[0];
            saveState();
            updateSelector();
            renderMap();
            updateProgress();
            document.getElementById('configModal').classList.add('hidden');
        }
    }

    function switchField() {
        const v = document.getElementById('fieldSelector').value;
        if(v === '__NEW__') {
            const n = prompt("New Field Name:");
            if(n && !state.fields[n]) {
                state.fields[n] = { config: {rows:4, lines:2, plants:5, maxScore:5}, data:{}, systems:{} };
                state.currentField = n;
            }
        } else state.currentField = v;
        updateSelector(); saveState(); renderMap(); updateProgress();
    }
    function updateSelector() {
        const s = document.getElementById('fieldSelector');
        s.innerHTML = '';
        Object.keys(state.fields).forEach(n => s.innerHTML += `<option value="${n}" ${n===state.currentField?'selected':''}>${n}</option>`);
        s.innerHTML += `<option value="__NEW__">+ NEW FIELD</option>`;
    }
    
    function importSystemNames(e) {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const lines = ev.target.result.split(/\r\n|\n/);
            let count = 0;
            lines.forEach(l => {
                const parts = l.split(',');
                if(parts.length >= 2) {
                    const id = parts[0].trim();
                    const name = parts[1].trim();
                    if(id && name) {
                        state.fields[state.currentField].systems[id] = name;
                        count++;
                    }
                }
            });
            saveState();
            renderMap();
            alert(`${count}ä»¶ã®ç³»çµ±åã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
            e.target.value = '';
        };
        r.readAsText(file);
    }

    function exportData() {
        let csv = "Field,ID,System,Score,Comment,Lat,Lon,Time,HasPhoto\n";
        Object.keys(state.fields).forEach(fn => {
            const f = state.fields[fn];
            for(const id in f.data) {
                const d = f.data[id];
                const hasP = d.photo ? 'Yes' : 'No';
                csv += `${fn},${id},${f.systems[id]||''},${d.score},"${d.comment}",${d.lat||''},${d.lon||''},${d.timestamp||''},${hasP}\n`;
            }
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv'}));
        a.download = `FieldEval_v3_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }
</script>
</body>
</html>